services:
  fake_api:
    image: mcr.microsoft.com/dotnet/sdk:DotnetSdkImagePlaceholder
    working_dir: /code
    volumes:
      - ./:/code
    command: dotnet run --project tests/NewApp.FakeAPI
    ports:
      - "9312:80"
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/80' 2>/dev/null || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  integration_tests:
    image: mcr.microsoft.com/dotnet/sdk:DotnetSdkImagePlaceholder
    working_dir: /code
    volumes:
      - ./:/code
    environment:
      - FAKE_API_URL=http://fake_api:80
    depends_on:
      fake_api:
        condition: service_healthy
    command: >
      bash -lc "dotnet build -c Release && dotnet run --project tests/NewApp.IntegrationTests -c Release --no-build"

# Usage:
#   docker compose up -d fake_api
#   docker compose run --rm integration_tests
# Ports:
#   - Fake API: http://localhost:9312 (maps to container 80)
