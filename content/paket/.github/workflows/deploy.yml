name: deploy

on:
  workflow_dispatch:
    inputs:
      version:
        required: true
        type: string
        description: "Release version (e.g. 0.1.42 â€” from the GitHub Release tag)"
      environment:
        required: true
        type: choice
        options:
          - stage
          - prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v6
        with:
          ref: "v${{ inputs.version }}"

      - name: Download Lambda artifact from release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download "v${{ inputs.version }}" --pattern "lambda-publish.zip"
          unzip lambda-publish.zip -d publish/

      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: cdk/package-lock.json

      # TODO: Configure AWS credentials for your account
      # - uses: aws-actions/configure-aws-credentials@master
      #   with:
      #     role-to-assume: arn:aws:iam::YOUR_ACCOUNT_ID:role/YOUR_OIDC_ROLE
      #     aws-region: eu-west-1

      - name: Install CDK dependencies
        working-directory: cdk
        run: npm ci

      - name: Deploy to ${{ inputs.environment }}
        working-directory: cdk
        run: |
          for attempt in 1 2 3; do
            echo "Deploy attempt $attempt/3..."
            if npx cdk deploy NewApp-${{ inputs.environment }} \
                --require-approval never; then
              echo "Deploy succeeded"
              exit 0
            fi
            if [ $attempt -lt 3 ]; then
              echo "Deploy failed, retrying in 30s..."
              sleep 30
            fi
          done
          echo "Deploy failed after 3 attempts"
          exit 1
        env:
          VERSION: ${{ inputs.version }}
